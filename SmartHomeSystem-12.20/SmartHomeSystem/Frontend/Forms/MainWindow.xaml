<Window x:Class="SmartHomeSystem.Frontend.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:lvc="clr-namespace:LiveCharts.Wpf;assembly=LiveCharts.Wpf"
        xmlns:local="clr-namespace:SmartHomeSystem.Frontend"
        mc:Ignorable="d"
        Title="Smart Home System"
        WindowStyle="None"
        WindowState="Maximized"
        ResizeMode="CanResizeWithGrip">

    <Window.Resources>
        <!-- 转换器 -->
        <local:PriorityToColorConverter x:Key="PriorityToBorderConverter" />
        <local:PriorityToColorConverter x:Key="PriorityToTextConverter" />
        <local:CriticalToColorConverter x:Key="CriticalToBackgroundConverter" />
        <local:CriticalToColorConverter x:Key="CriticalToTextConverter" />
        <local:RecoveryChanceToColorConverter x:Key="ChanceToColorConverter" />
        <local:OverloadLevelToColorConverter x:Key="OverloadLevelToColorConverter" />
        <local:CycleToColorConverter x:Key="CycleToColorConverter" />
        <local:CycleToTextColorConverter x:Key="CycleToTextColorConverter" />
        <local:CycleToHeaderColorConverter x:Key="CycleToHeaderColorConverter" />

        <!-- 设备可视化样式 -->
        <Style x:Key="DeviceVisualStyle" TargetType="Border">
            <Setter Property="Width" Value="120" />
            <Setter Property="Height" Value="80" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="BorderThickness" Value="2" />
            <Setter Property="Background">
                <Setter.Value>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                        <GradientStop Color="#FFFFFFFF" Offset="0" />
                        <GradientStop Color="#FFE0E0E0" Offset="1" />
                    </LinearGradientBrush>
                </Setter.Value>
            </Setter>
            <Setter Property="BorderBrush" Value="#FF808080" />
            <Setter Property="Cursor" Value="Hand" />
        </Style>

        <!-- 选中状态的设备样式 -->
        <Style x:Key="SelectedDeviceStyle" TargetType="Border" BasedOn="{StaticResource DeviceVisualStyle}">
            <Setter Property="BorderBrush" Value="#FF0078D7" />
            <Setter Property="Background">
                <Setter.Value>
                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                        <GradientStop Color="#FFFFFFFF" Offset="0" />
                        <GradientStop Color="#FFC0E0FF" Offset="1" />
                    </LinearGradientBrush>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- 连接点样式 -->
        <Style x:Key="ConnectionPointStyle" TargetType="Ellipse">
            <Setter Property="Width" Value="14" />
            <Setter Property="Height" Value="14" />
            <Setter Property="Fill" Value="#FFC0C0C0" />
            <Setter Property="Stroke" Value="#FF606060" />
            <Setter Property="StrokeThickness" Value="1.5" />
            <Setter Property="Cursor" Value="Hand" />
        </Style>

        <!-- 连接线样式 -->
        <Style x:Key="ConnectionLineStyle" TargetType="Path">
            <Setter Property="Stroke" Value="#FF3498DB" />
            <Setter Property="StrokeThickness" Value="2" />
            <Setter Property="StrokeEndLineCap" Value="Round" />
            <Setter Property="StrokeStartLineCap" Value="Round" />
        </Style>

        <!-- 临时连接线样式 -->
        <Style x:Key="TemporaryConnectionStyle" TargetType="Path" BasedOn="{StaticResource ConnectionLineStyle}">
            <Setter Property="Stroke" Value="#FF95A5A6" />
            <Setter Property="StrokeDashArray" Value="5,3" />
        </Style>

        <!-- 调试面板样式 -->
        <Style x:Key="DebugPanelStyle" TargetType="Border">
            <Setter Property="BorderBrush" Value="#db855c" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Background" Value="#FFF5F5F5" />
            <Setter Property="CornerRadius" Value="5" />
            <Setter Property="Margin" Value="2" />
        </Style>

        <Style x:Key="DebugSectionStyle" TargetType="Border">
            <Setter Property="BorderBrush" Value="#FFCCCCCC" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Background" Value="#FFF0F0F0" />
            <Setter Property="CornerRadius" Value="3" />
            <Setter Property="Margin" Value="5" />
            <Setter Property="Padding" Value="8" />
        </Style>

        <!-- 属性编辑器样式 -->
        <Style x:Key="PropertyEditorStyle" TargetType="StackPanel">
            <Setter Property="Margin" Value="0,2" />
        </Style>

        <Style x:Key="PropertyLabelStyle" TargetType="Label">
            <Setter Property="Width" Value="80" />
            <Setter Property="FontWeight" Value="SemiBold" />
            <Setter Property="VerticalAlignment" Value="Center" />
        </Style>

        <Style x:Key="PropertyTextBoxStyle" TargetType="TextBox">
            <Setter Property="Width" Value="100" />
            <Setter Property="Height" Value="22" />
            <Setter Property="Margin" Value="5,0,0,0" />
        </Style>

        <!-- 调度状态样式 -->
        <Style x:Key="StatusIndicatorStyle" TargetType="Border">
            <Setter Property="Background" Value="#FFF8F9FA" />
            <Setter Property="BorderBrush" Value="#DEE2E6" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Padding" Value="8" />
            <Setter Property="Margin" Value="2" />
        </Style>

        <!-- 优先级标签样式 -->
        <Style x:Key="PriorityTagStyle" TargetType="Border">
            <Setter Property="Background" Value="#FFE9ECEF" />
            <Setter Property="CornerRadius" Value="12" />
            <Setter Property="Padding" Value="6,2" />
            <Setter Property="HorizontalAlignment" Value="Left" />
        </Style>

        <!-- 新增：周期组标题样式 -->
        <Style x:Key="CycleGroupHeaderStyle" TargetType="Border">
            <Setter Property="Background" Value="#FF4A6572" />
            <Setter Property="BorderBrush" Value="#FF344955" />
            <Setter Property="BorderThickness" Value="1,1,1,0" />
            <Setter Property="CornerRadius" Value="4,4,0,0" />
            <Setter Property="Padding" Value="8,4" />
            <Setter Property="Margin" Value="3,5,3,0" />
        </Style>

        <!-- 周期组内容样式 -->
        <Style x:Key="CycleGroupContentStyle" TargetType="Border">
            <Setter Property="Background" Value="#FFF8F9FA" />
            <Setter Property="BorderBrush" Value="#FFDEE2E6" />
            <Setter Property="BorderThickness" Value="1,0,1,1" />
            <Setter Property="CornerRadius" Value="0,0,4,4" />
            <Setter Property="Margin" Value="3,0,3,5" />
            <Setter Property="Padding" Value="5" />
        </Style>

        <!-- 空周期组提示样式 -->
        <Style x:Key="EmptyCycleGroupStyle" TargetType="TextBlock">
            <Setter Property="Text" Value="暂无挂起设备" />
            <Setter Property="Foreground" Value="#FF95A5A6" />
            <Setter Property="FontStyle" Value="Italic" />
            <Setter Property="HorizontalAlignment" Value="Center" />
            <Setter Property="VerticalAlignment" Value="Center" />
            <Setter Property="Padding" Value="20" />
        </Style>
    </Window.Resources>

    <!-- 使用Viewbox实现整体自缩放 -->
    <Viewbox Stretch="Uniform">
        <Grid Width="1920" Height="1080" MinWidth="800" MinHeight="600">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="400" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="300" />
            </Grid.ColumnDefinitions>

            <!-- 左侧区域（功能区域） -->
            <Border Grid.Column="0" BorderBrush="Black" BorderThickness="1" Margin="10">
                <StackPanel>
                    <!-- 时间区域 -->
                    <Border BorderBrush="Black" BorderThickness="1" Margin="5" Padding="10" Height="120">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="Auto" />
                            </Grid.RowDefinitions>

                            <Label Name="TimeLabel" Content="{Binding DisplayTime}" FontWeight="Bold" />
                            <!-- 速度选择按钮 -->
                            <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Center">
                                <RadioButton Name="pause" Content="暂停" GroupName="TimeSpeed" FontWeight="Bold" Margin="5" Checked="RadioButton_Checked" IsChecked="True" />
                                <RadioButton Name="speed1" Content="实时" GroupName="TimeSpeed" FontWeight="Bold" Margin="5" Checked="RadioButton_Checked" />
                                <RadioButton Name="speed2" Content="低速" GroupName="TimeSpeed" FontWeight="Bold" Margin="5" Checked="RadioButton_Checked" />
                                <RadioButton Name="speed3" Content="中速" GroupName="TimeSpeed" FontWeight="Bold" Margin="5" Checked="RadioButton_Checked" />
                                <RadioButton Name="speed4" Content="快速" GroupName="TimeSpeed" FontWeight="Bold" Margin="5" Checked="RadioButton_Checked" />
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- 统计区域 -->
                    <Border BorderBrush="Black" BorderThickness="1" Margin="5" Padding="10" Height="480">
                        <StackPanel>
                            <Label Name="RootLabel" Content="统计" FontWeight="Bold" Margin="0,0,0,10" />
                            <Border BorderBrush="Black" BorderThickness="1" Height="219">
                                <lvc:CartesianChart Name="ChartData" Series="{Binding SeriesCollection}"
                                                    LegendLocation="Right"
                                                    Margin="5"
                                                    HorizontalAlignment="Stretch"
                                                    VerticalAlignment="Stretch"
                                                    MouseDown="ChartDataMouseDown"
                                                    Cursor="Hand">
                                    <lvc:CartesianChart.AxisY>
                                        <lvc:Axis LabelFormatter="{Binding YFormatter}" />
                                    </lvc:CartesianChart.AxisY>
                                    <lvc:CartesianChart.AxisX>
                                        <lvc:Axis Name="XAxis" Title="时间" Labels="{Binding XFormatter}">
                                            <lvc:Axis.Separator>
                                                <lvc:Separator Step="1" />
                                            </lvc:Axis.Separator>
                                        </lvc:Axis>
                                    </lvc:CartesianChart.AxisX>
                                </lvc:CartesianChart>
                            </Border>

                            <StackPanel Margin="0,10,0,0">
                                <Label Content="{Binding DisplayRootPowerConsumption}" Margin="0,2" />
                                <Label Content="{Binding DisplayRootPowerProduction}" Margin="0,2" />
                                <Label Content="{Binding DisplayRootRealPower}" Margin="0,2" />
                                <Label Content="{Binding DisplayRootElectricityPricing}" Margin="0,2" />
                                <Label Content="{Binding DisplayRootCumulativeElectricityConsumption}" Margin="0,2" />
                                <Label Content="{Binding DisplayRootCumulativeElectricityPricing}" Margin="0,2" />
                            </StackPanel>
                        </StackPanel>
                    </Border>

                    <!-- 当前节点区域 -->
                    <Border BorderBrush="Black" BorderThickness="1" Margin="5" Padding="10" Height="429">
                        <StackPanel>
                            <Button Name="SaveButton" Content="加载设备" Margin="20" Height="51" Width="258" Click="LoadButtonClick" />
                            <Button Name="LoadButton" Content="保存设备" Margin="20" Height="51" Width="258" Click="SaveButtonClick" />
                            <Button Name="EmptyButton" Content="清空设备" Margin="20" Height="51" Width="258" Click="EmptyButtonClick" />
                            <Button Name="ExitButton" Content="退出系统" Margin="20" Height="51" Width="258" Click="ExitButtonClick" />
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Border>

            <!-- 右侧主区域 -->
            <Border Name="RightView" Grid.Column="1" BorderBrush="Gray" BorderThickness="1" Margin="5,10,10,10" Background="LightGray" Grid.ColumnSpan="2">
                <Grid Margin="0,0,9,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="380" />
                        <ColumnDefinition Width="300" />
                    </Grid.ColumnDefinitions>

                    <!-- 拓扑树视图 -->
                        <TreeView x:Name="TopologyTreeView"
              Grid.Column="0" 
              Margin="0,0,5,0" 
              Background="White"
              FontSize="20"
              ItemsSource="{Binding TreeNodes}"
              SelectedItemChanged="TopologyTreeView_SelectedItemChanged">

                            <!-- 添加上下文菜单 -->
                            <TreeView.ContextMenu>
                                <ContextMenu DataContext="{Binding PlacementTarget.DataContext.ContextMenuVM,
                     RelativeSource={RelativeSource Self}}"
                 IsOpen="{Binding IsMenuVisible, Mode=TwoWay}">

                                    <!-- 删除节点菜单项 -->
                                    <MenuItem Header="删除"
                  Command="{Binding DeleteNodeCommand}"
                  Click="Remove_Click"
                  Visibility="{Binding CanDeleteNode, Converter={x:Static local:BoolToVisibilityConverter.Instance}}" />

                                    <Separator Visibility="{Binding CanDeleteNode, Converter={x:Static local:BoolToVisibilityConverter.Instance}}" />

                                    <!-- 添加线路菜单项 -->
                                    <MenuItem Header="增加新线路"
                  Command="{Binding AddLineCommand}"
                  Click="AddLine_Click"
                  Visibility="{Binding CanAddLine, Converter={x:Static local:BoolToVisibilityConverter.Instance}}" />

                                    <!-- 添加设备菜单项 -->
                                    <MenuItem Header="增加新设备"
                  Command="{Binding AddDeviceCommand}"
                  Click="AddDevice_Click"
                  Visibility="{Binding CanAddDevice, Converter={x:Static local:BoolToVisibilityConverter.Instance}}" />
                                </ContextMenu>
                            </TreeView.ContextMenu>

                            <TreeView.ItemTemplate>
                                <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                    <StackPanel Orientation="Horizontal" Margin="2">
                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold" Margin="0,0,10,0" />
                                        <TextBlock Text="{Binding NodeTypeDisplay}" Foreground="Gray" Margin="0,0,10,0" />
                                        <TextBlock Text="{Binding StatusDisplay}" Foreground="Green" />
                                        <TextBlock Text="{Binding PowerInfo}" Foreground="DarkBlue" Margin="10,0,0,0" />
                                    </StackPanel>
                                </HierarchicalDataTemplate>
                            </TreeView.ItemTemplate>

                            <TreeView.ItemContainerStyle>
                                <Style TargetType="{x:Type TreeViewItem}">
                                    <Setter Property="IsExpanded" Value="{Binding IsExpanded, Mode=TwoWay}" />
                                    <Setter Property="IsSelected" Value="{Binding IsSelected, Mode=TwoWay}" />
                                    <!-- 添加右键点击事件 -->
                                    <EventSetter Event="PreviewMouseRightButtonDown" Handler="TreeViewItem_PreviewMouseRightButtonDown" />
                                </Style>
                            </TreeView.ItemContainerStyle>
                        </TreeView>

                    <!-- 调度状态和队列区域 -->
                    <Border Grid.Column="1" BorderBrush="Black" BorderThickness="1" Background="#FFF8F8F8">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                                <RowDefinition Height="200" />
                            </Grid.RowDefinitions>

                            <!-- 调度状态概览 -->
                            <Border Grid.Row="0" Background="#FFE8F4FD" BorderBrush="#FF3498DB" BorderThickness="0,0,0,1" Padding="8">
                                <StackPanel>
                                    <TextBlock Text="调度状态概览" FontWeight="Bold" Foreground="#FF2C3E50" Margin="0,0,0,4" />
                                    <TextBlock Text="{Binding CurrentRecoveryInfo}" FontSize="10" Foreground="#FF34495E" />
                                    <Grid Margin="0,4,0,0">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*" />
                                            <ColumnDefinition Width="180*" />
                                            <ColumnDefinition Width="181*" />
                                        </Grid.ColumnDefinitions>
                                        <StackPanel Grid.Column="1" Orientation="Horizontal">
                                            <TextBlock Text="挂起设备:" FontWeight="SemiBold" Foreground="#FF3498DB" FontSize="16" />
                                            <TextBlock Text="{Binding SchedulingStatus.SuspendedDeviceCount}" Margin="4,0,0,0" />
                                        </StackPanel>
                                        <StackPanel Grid.Column="2" Orientation="Horizontal">
                                            <TextBlock Text="恢复比例:" FontWeight="SemiBold" Foreground="#FF27AE60" FontSize="16" />
                                            <TextBlock Text="{Binding SchedulingStatus.CurrentRecoveryRatio, StringFormat={}{0:P0}}" Margin="4,0,0,0" />
                                        </StackPanel>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- 挂起队列区域 - 修改为分层显示 -->
                            <Border BorderBrush="#FFE0E0E0" BorderThickness="0,2,0,0" Background="#FFF5F5F5" Margin="0,73,0,0" Grid.RowSpan="3">
                                <DockPanel>
                                    <Label Content="挂起队列（按恢复周期分组）" DockPanel.Dock="Top"
                                           Background="#FFF0F0F0" FontWeight="Bold" FontSize="16"
                                           Foreground="#FF555555" HorizontalContentAlignment="Center" Padding="8" />

                                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                                        <ItemsControl ItemsSource="{Binding SuspendQueueByCycle}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <StackPanel Margin="0,0,0,8">
                                                        <!-- 周期组标题 -->
                                                        <Border Style="{StaticResource CycleGroupHeaderStyle}"
                                                                Background="{Binding CycleIndex, Converter={StaticResource CycleToHeaderColorConverter}}">
                                                            <Grid>
                                                                <Grid.ColumnDefinitions>
                                                                    <ColumnDefinition Width="*" />
                                                                    <ColumnDefinition Width="Auto" />
                                                                </Grid.ColumnDefinitions>

                                                                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                                                                    <TextBlock Text="{Binding CycleTitle}"
                                                                               FontWeight="Bold"
                                                                               Foreground="White"
                                                                               Margin="0,0,8,0" />

                                                                    <TextBlock Text="{Binding CycleDescription}"
                                                                               FontSize="10"
                                                                               Foreground="#FFE0E0E0"
                                                                               VerticalAlignment="Center" />
                                                                </StackPanel>

                                                                <StackPanel Grid.Column="1" Orientation="Horizontal">
                                                                    <TextBlock Text="设备数量:"
                                                                               FontSize="10"
                                                                               Foreground="#FFE0E0E0"
                                                                               Margin="0,0,4,0" />
                                                                    <TextBlock Text="{Binding DeviceCount}"
                                                                               FontWeight="SemiBold"
                                                                               Foreground="White"
                                                                               FontSize="12" />
                                                                </StackPanel>
                                                            </Grid>
                                                        </Border>

                                                        <!-- 周期组内容 -->
                                                        <Border Style="{StaticResource CycleGroupContentStyle}">
                                                            <ItemsControl ItemsSource="{Binding Devices}">
                                                                <ItemsControl.ItemTemplate>
                                                                    <DataTemplate>
                                                                        <!-- 根据恢复周期设置不同的背景色 -->
                                                                        <Border Background="{Binding RecoveryCycle, Converter={StaticResource CycleToColorConverter}}"
                                                                                BorderBrush="#FFDDDDDD"
                                                                                BorderThickness="1"
                                                                                Margin="2"
                                                                                Padding="6"
                                                                                CornerRadius="3">
                                                                            <Grid>
                                                                                <Grid.ColumnDefinitions>
                                                                                    <ColumnDefinition Width="30" />
                                                                                    <ColumnDefinition Width="*" />
                                                                                    <ColumnDefinition Width="60" />
                                                                                </Grid.ColumnDefinitions>

                                                                                <!-- 优先级标识 -->
                                                                                <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                                                                    <TextBlock Text="优先级" FontSize="7" Foreground="#FF666666" HorizontalAlignment="Center" />
                                                                                    <TextBlock Text="{Binding PriorityLevel}"
                                                                                               FontWeight="Bold"
                                                                                               FontSize="10"
                                                                                               Foreground="{Binding PriorityLevel, Converter={StaticResource PriorityToTextConverter}}"
                                                                                               HorizontalAlignment="Center" />
                                                                                </StackPanel>

                                                                                <!-- 设备信息 -->
                                                                                <StackPanel Grid.Column="1" Margin="4,0">
                                                                                    <TextBlock Text="{Binding DeviceName}"
                                                                                               FontWeight="SemiBold"
                                                                                               FontSize="11"
                                                                                               Foreground="#FF222222" />
                                                                                    <TextBlock Text="{Binding PowerConsumption}"
                                                                                               FontSize="9"
                                                                                               Foreground="#FFE67E22"
                                                                                               Margin="0,1,0,0" />
                                                                                </StackPanel>

                                                                                <!-- 状态信息 -->
                                                                                <StackPanel Grid.Column="2">
                                                                                    <TextBlock Text="{Binding WaitTime}"
                                                                                               FontSize="8"
                                                                                               Foreground="#FF666666"
                                                                                               Margin="0,0,0,1" />
                                                                                    <TextBlock Text="恢复几率"
                                                                                               FontSize="7"
                                                                                               Foreground="#FF888888" />
                                                                                    <TextBlock Text="{Binding RecoveryChance}"
                                                                                               FontSize="8"
                                                                                               FontWeight="Bold"
                                                                                               Foreground="{Binding RecoveryChance, Converter={StaticResource ChanceToColorConverter}}" />
                                                                                </StackPanel>
                                                                            </Grid>
                                                                        </Border>
                                                                    </DataTemplate>
                                                                </ItemsControl.ItemTemplate>

                                                                <ItemsControl.ItemContainerStyle>
                                                                    <Style TargetType="ContentPresenter">
                                                                        <Setter Property="Margin" Value="0,1" />
                                                                    </Style>
                                                                </ItemsControl.ItemContainerStyle>

                                                                <!-- 空周期组提示 -->
                                                                <ItemsControl.Style>
                                                                    <Style TargetType="ItemsControl">
                                                                        <Setter Property="Template">
                                                                            <Setter.Value>
                                                                                <ControlTemplate TargetType="ItemsControl">
                                                                                    <StackPanel>
                                                                                        <ItemsPresenter />
                                                                                        <ContentControl Content="{TemplateBinding ItemsSource}">
                                                                                            <ContentControl.Style>
                                                                                                <Style TargetType="ContentControl">
                                                                                                    <Style.Triggers>
                                                                                                        <DataTrigger Binding="{Binding Items.Count, RelativeSource={RelativeSource AncestorType=ItemsControl}}" Value="0">
                                                                                                            <Setter Property="ContentTemplate">
                                                                                                                <Setter.Value>
                                                                                                                    <DataTemplate>
                                                                                                                        <TextBlock Style="{StaticResource EmptyCycleGroupStyle}" />
                                                                                                                    </DataTemplate>
                                                                                                                </Setter.Value>
                                                                                                            </Setter>
                                                                                                        </DataTrigger>
                                                                                                    </Style.Triggers>
                                                                                                </Style>
                                                                                            </ContentControl.Style>
                                                                                        </ContentControl>
                                                                                    </StackPanel>
                                                                                </ControlTemplate>
                                                                            </Setter.Value>
                                                                        </Setter>
                                                                    </Style>
                                                                </ItemsControl.Style>
                                                            </ItemsControl>
                                                        </Border>
                                                    </StackPanel>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>

                                            <ItemsControl.ItemContainerStyle>
                                                <Style TargetType="ContentPresenter">
                                                    <Setter Property="Margin" Value="0,2" />
                                                </Style>
                                            </ItemsControl.ItemContainerStyle>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </DockPanel>
                            </Border>
                        </Grid>
                    </Border>

                    <!-- 调试面板 -->
                    <Border Grid.Column="2" Style="{StaticResource DebugPanelStyle}">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="*" />
                                <RowDefinition Height="2" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>

                            <!-- 上部分：节点属性编辑 -->
                            <Border Grid.Row="0" Style="{StaticResource DebugSectionStyle}">
                                <ScrollViewer VerticalScrollBarVisibility="Auto">
                                    <StackPanel>
                                        <Label Content="节点属性" FontWeight="Bold" Foreground="#FF333333" Margin="0,0,0,5" />
                                        <Label Content="{Binding SelectedNodeInfo}" FontStyle="Italic" Margin="0,0,0,10" />

                                        <!-- 节点基本属性 -->
                                        <StackPanel Style="{StaticResource PropertyEditorStyle}">
                                            <Label Content="节点属性" FontWeight="Bold" Margin="0,5,0,2" />

                                            <StackPanel Orientation="Horizontal">
                                                <Label Content="开关状态:" Style="{StaticResource PropertyLabelStyle}" />
                                                <CheckBox IsChecked="{Binding NodeSwitchStatus}" VerticalAlignment="Center" />
                                            </StackPanel>

                                            <StackPanel Orientation="Horizontal">
                                                <Label Content="最大功率:" Style="{StaticResource PropertyLabelStyle}" />
                                                <TextBox Text="{Binding NodeMaxPower}" Style="{StaticResource PropertyTextBoxStyle}" />
                                                <Label Content="KW" VerticalAlignment="Center" Margin="5,0,0,0" />
                                            </StackPanel>

                                            <StackPanel Orientation="Horizontal">
                                                <Label Content="功率计划:" Style="{StaticResource PropertyLabelStyle}" />
                                                <ComboBox SelectedItem="{Binding NodePowerPlan}" Width="120" Margin="5,0,0,0">
                                                    <ComboBoxItem Content="关键" />
                                                    <ComboBoxItem Content="重要" />
                                                    <ComboBoxItem Content="普通" />
                                                    <ComboBoxItem Content="低优先级" />
                                                </ComboBox>
                                            </StackPanel>

                                            <!-- 修改后的按钮布局：水平排列，等宽 -->
                                            <StackPanel Orientation="Horizontal" Margin="0,10,0,5" HorizontalAlignment="Center">
                                                <Button Content="刷新" Command="{Binding RefreshDebugPanelCommand}"
                                    Width="80" Height="25" Margin="0,0,5,0"
                                    Background="#FF607D8B" Foreground="White"
                                    ToolTip="刷新当前节点数据" />
                                                <Button Content="应用" Command="{Binding ApplyNodeChangesCommand}"
                                    Width="80" Height="25"
                                    Background="#FF4CAF50" Foreground="White"
                                    ToolTip="应用节点属性修改" />
                                            </StackPanel>
                                        </StackPanel>
                                    </StackPanel>
                                </ScrollViewer>
                            </Border>

                            <!-- 分隔线 -->
                            <Border Grid.Row="1" Background="#FFCCCCCC" Margin="5,0" />

                            <!-- 下部分：设备属性编辑 -->
                            <Border Grid.Row="2" Style="{StaticResource DebugSectionStyle}">
                                <ScrollViewer VerticalScrollBarVisibility="Auto">
                                    <StackPanel>
                                        <Label Content="设备属性" FontWeight="Bold" Foreground="#FF333333" Margin="0,0,0,5" />
                                        <Label Content="{Binding SelectedDeviceInfo}" FontStyle="Italic" Margin="0,0,0,10" />

                                        <!-- 设备基本属性 -->
                                        <StackPanel Style="{StaticResource PropertyEditorStyle}">
                                            <Label Content="基本属性" FontWeight="Bold" Margin="0,5,0,2" />

                                            <StackPanel Orientation="Horizontal">
                                                <Label Content="设备开关:" Style="{StaticResource PropertyLabelStyle}" />
                                                <CheckBox IsChecked="{Binding DeviceSwitchStatus}" VerticalAlignment="Center" />
                                            </StackPanel>

                                            <StackPanel Orientation="Horizontal">
                                                <Label Content="性能评级:" Style="{StaticResource PropertyLabelStyle}" />
                                                <TextBox Text="{Binding DevicePerformance}" Style="{StaticResource PropertyTextBoxStyle}" />
                                                <Label Content="%" VerticalAlignment="Center" Margin="5,0,0,0" />
                                            </StackPanel>

                                            <StackPanel Orientation="Horizontal" Visibility="{Binding IsConsumerVisible}">
                                                <Label Content="消耗功率:" Style="{StaticResource PropertyLabelStyle}" />
                                                <TextBox Text="{Binding DevicePowerConsumption}" Style="{StaticResource PropertyTextBoxStyle}" />
                                                <Label Content="KW" VerticalAlignment="Center" Margin="5,0,0,0" />
                                            </StackPanel>

                                            <StackPanel Orientation="Horizontal" Visibility="{Binding IsProducerVisible}">
                                                <Label Content="生产功率:" Style="{StaticResource PropertyLabelStyle}" />
                                                <TextBox Text="{Binding DevicePowerProduction}" Style="{StaticResource PropertyTextBoxStyle}" />
                                                <Label Content="KW" VerticalAlignment="Center" Margin="5,0,0,0" />
                                            </StackPanel>

                                            <StackPanel Orientation="Horizontal">
                                                <Label Content="设备类型:" Style="{StaticResource PropertyLabelStyle}" />
                                                <Label Content="{Binding DeviceType}" VerticalAlignment="Center" Margin="5,0,0,0" />
                                            </StackPanel>

                                            <!-- 修改后的按钮布局：水平排列，等宽 -->
                                            <StackPanel Orientation="Horizontal" Margin="0,10,0,5" HorizontalAlignment="Center">
                                                <Button Content="刷新" Command="{Binding RefreshDebugPanelCommand}"
                                    Width="80" Height="25" Margin="0,0,5,0"
                                    Background="#FF607D8B" Foreground="White"
                                    ToolTip="刷新当前设备数据" />
                                                <Button Content="应用" Command="{Binding ApplyDeviceChangesCommand}"
                                    Width="80" Height="25"
                                    Background="#FF2196F3" Foreground="White"
                                    ToolTip="应用设备属性修改" />
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- 设备高级属性 -->
                                        <StackPanel Style="{StaticResource PropertyEditorStyle}" Margin="0,10,0,0">
                                            <Label Content="高级属性" FontWeight="Bold" Margin="0,5,0,2" />

                                            <StackPanel Orientation="Horizontal">
                                                <Label Content="设备ID:" Style="{StaticResource PropertyLabelStyle}" />
                                                <TextBox Text="{Binding DeviceId}" Style="{StaticResource PropertyTextBoxStyle}" IsReadOnly="True" Background="#FFEEEEEE" />
                                            </StackPanel>

                                            <StackPanel Orientation="Horizontal">
                                                <Label Content="父节点:" Style="{StaticResource PropertyLabelStyle}" />
                                                <TextBox Text="{Binding ParentNodeId}" Style="{StaticResource PropertyTextBoxStyle}" IsReadOnly="True" Background="#FFEEEEEE" />
                                            </StackPanel>
                                        </StackPanel>
                                    </StackPanel>
                                </ScrollViewer>
                            </Border>
                        </Grid>
                    </Border>
                </Grid>
            </Border>
        </Grid>
    </Viewbox>
</Window>